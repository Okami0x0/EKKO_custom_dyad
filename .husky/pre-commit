#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Security check: Prevent committing sensitive data
echo "ğŸ”’ Running security checks..."

# Check for potential API keys or secrets in staged files
if git diff --cached --name-only | xargs grep -l "api.*key\|secret\|token\|password" 2>/dev/null; then
    echo "âŒ SECURITY WARNING: Potential API keys or secrets detected in staged files!"
    echo "ğŸ“‹ Files with potential secrets:"
    git diff --cached --name-only | xargs grep -l "api.*key\|secret\|token\|password" 2>/dev/null
    echo ""
    echo "ğŸ›¡ï¸  Please review these files and ensure no real credentials are being committed."
    echo "ğŸ’¡ Use environment variables or .env files for sensitive data."
    echo ""
    echo "To bypass this check (only if you're sure it's safe):"
    echo "git commit --no-verify"
    exit 1
fi

# Check for .env files
if git diff --cached --name-only | grep -E "\.env$|\.env\..*$" | grep -v "\.env\.example$" | grep -v "\.env\.template$"; then
    echo "âŒ SECURITY WARNING: .env file detected in staged files!"
    echo "ğŸ“‹ Detected .env files:"
    git diff --cached --name-only | grep -E "\.env$|\.env\..*$" | grep -v "\.env\.example$" | grep -v "\.env\.template$"
    echo ""
    echo "ğŸ›¡ï¸  .env files should never be committed to version control!"
    echo "ğŸ’¡ Add them to .gitignore and use .env.example as a template."
    exit 1
fi

# Check for database files
if git diff --cached --name-only | grep -E "\.(db|sqlite|sqlite3)$"; then
    echo "âŒ SECURITY WARNING: Database files detected in staged files!"
    echo "ğŸ“‹ Detected database files:"
    git diff --cached --name-only | grep -E "\.(db|sqlite|sqlite3)$"
    echo ""
    echo "ğŸ›¡ï¸  Database files may contain sensitive user data!"
    echo "ğŸ’¡ These should typically be excluded from version control."
    exit 1
fi

echo "âœ… Security checks passed!"

# Run existing linting
npx lint-staged
